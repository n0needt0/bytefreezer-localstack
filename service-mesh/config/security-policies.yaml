# Security policies for the service mesh
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: default
  namespace: localstack
spec:
  mtls:
    mode: PERMISSIVE  # Allow both mTLS and plain text for development
---
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: default
  namespace: bytefreezer-dev
spec:
  mtls:
    mode: PERMISSIVE
---
# Authorization policies for ByteFreezer services
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: bytefreezer-proxy-authz
  namespace: bytefreezer-dev
spec:
  selector:
    matchLabels:
      app: bytefreezer-proxy
  rules:
  - from:
    - source:
        namespaces: ["bytefreezer-dev", "localstack", "istio-system"]
  - to:
    - operation:
        methods: ["GET", "POST"]
        paths: ["/api/*", "/health", "/metrics"]
  - to:
    - operation:
        ports: ["2056", "2057"]  # UDP ports
---
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: bytefreezer-receiver-authz
  namespace: bytefreezer-dev
spec:
  selector:
    matchLabels:
      app: bytefreezer-receiver
  rules:
  - from:
    - source:
        namespaces: ["bytefreezer-dev", "localstack"]
  - from:
    - source:
        principals: ["cluster.local/ns/bytefreezer-dev/sa/bytefreezer-proxy"]
  - to:
    - operation:
        methods: ["GET", "POST", "PUT"]
        paths: ["/data/*", "/health", "/metrics"]
---
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: localstack-authz
  namespace: localstack
spec:
  selector:
    matchLabels:
      app: localstack
  rules:
  - from:
    - source:
        namespaces: ["bytefreezer-dev", "localstack", "default"]
  - to:
    - operation:
        methods: ["GET", "POST", "PUT", "DELETE", "HEAD"]
---
# Network policies for additional security
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: bytefreezer-network-policy
  namespace: bytefreezer-dev
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: istio-system
    - namespaceSelector:
        matchLabels:
          name: localstack
    - namespaceSelector:
        matchLabels:
          name: bytefreezer-dev
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: localstack
  - to:
    - namespaceSelector:
        matchLabels:
          name: istio-system
  - to: []
    ports:
    - protocol: TCP
      port: 53
    - protocol: UDP
      port: 53